{% extends 'base/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block head %}
{% endblock %}

{% block detail %}

<div class="row">
    <div class="col-sm-6 overflow-auto">
        <form method="POST" name="block" enctype="multipart/form-data">{% csrf_token %}
            <div class="form-floating">

                <div class="control has-icons-left" style="width: 100%">
                    {{ form.desc | add_class:"form-control" |attr:"placeholder:hello"}}
                </div>
                <div class="control float-right">
                    <button class="btn btn-sm btn-secondary" type="submit" >
                        생성하기
                    </button>
                </div>
            </div>
        </form>
        <div class="list-group" id="list_order">
            {% comment %}if an item was activated, add class 'active'{% endcomment %}
            {% for li in list %}
                <div>
                    <a class="list-group-item list-group-item-action {% if li.pk == block_item.pk%} active {% endif %}" href="{% url 'scenario_detail_block' data.pk li.pk%}" onclick="activeSelector()">
                        <div class="d-flex w-100 justify-content-between">
    {#                        <small class="text-muted">{{ li.created_at }}</small>#}
                        </div>
                        <p class="mb-1">{{ li.desc }}</p>
                        <small class="text-muted">{{ li.created_at }}</small>
                    </a>
                </div>

            {% endfor %}


        </div>
    </div>
    <div class="col-sm-6 overflow-auto">

        <p>{{ block_item.desc }}</p>
        <p>{{ block_item.created_at }}</p>
        <p>{{ block_item.updated_at }}</p>
        <p>수정하기</p>
        <p>삭제하기</p>
        <hr>
        <div>
            <a class="btn btn-sm" data-bs-toggle="collapse" href="#write_comments" role="button" aria-expanded="false" aria-controls="collapseExample">
                comment 쓰기
            </a>
        </div>
        <div class="collapse" id="write_comments">
            <form method="POST" name="block" enctype="multipart/form-data">{% csrf_token %}
                <div>{{ comment_form.status |add_class:"form-select"}}</div>
                <div>{{ comment_form.desc |add_class:"form-control"}}</div>
                <div id="image_container"></div>
                <div>{{ comment_form.image_1|attr:"onchange:setThumbnail(event)" | add_class:"attached form-control" }}</div>
                <div>{{ comment_form.image_2|attr:"onchange:setThumbnail(event)" | add_class:"attached form-control" }}</div>
                <div>{{ comment_form.image_3|attr:"onchange:setThumbnail(event)" | add_class:"attached form-control" }}</div>
                <div>{{ comment_form.image_4|attr:"onchange:setThumbnail(event)" | add_class:"attached form-control" }}</div>
                <div>{{ comment_form.image_5|attr:"onchange:setThumbnail(event)" | add_class:"attached form-control" }}</div>
                <div>
                    <input class="btn btn-primary" type="submit" value="제출하기" onclick="console.log(123)">
                </div>
            </form>
        </div>

        <hr>
        <div>

            {% if comments_list %}
                {% for comments in comments_list %}
                    <div class="card mb-3" style="max-width: 800px;">
                        <div class="card-header">
                            <span>{{ comments.writer }}</span>
                        </div>
                        <div class="card-body">

                            <p class="card-text">{{ comments.desc }}</p>


                        </div>

                            <div class="card-footer bg-transparent border-success">
                                {% if comments.image_1 %}
                                <a class="btn btn-sm" data-bs-toggle="collapse" href="#col_id_{{ comments.pk }}" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    사진보기
                                </a>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-primary position-relative">
                                    댓글
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                        10
                                    <span class="visually-hidden">unread messages</span>
                                    </span>
                                </button>
                            </div>




                        <div class="collapse" id="col_id_{{ comments.pk }}">
                            {% if comments.image_1 %}
                                <img src="{{ comments.image_1.url }}" class="img-fluid" alt="...">
                            {% endif %}
                            {% if comments.image_2 %}
                                <img src="{{ comments.image_2.url }}" class="img-fluid" alt="...">
                            {% endif %}
                            {% if comments.image_3 %}
                                <img src="{{ comments.image_3.url }}" class="img-fluid" alt="...">
                            {% endif %}
                            {% if comments.image_4 %}
                                <img src="{{ comments.image_4.url }}" class="img-fluid" alt="...">
                            {% endif %}
                            {% if comments.image_5 %}
                                <img src="{{ comments.image_5.url }}" class="img-fluid" alt="...">
                            {% endif %}

                        </div>
                    </div>
                {% endfor %}

        {% else %}
            <p>아직 코멘트가 없습니다.</p>
        {% endif %}

        </div>
        <hr>

    </div>
</div>


{% endblock %}

{% block list %}



{% endblock %}

{% block input %}


{% endblock %}

{% block script %}
    <script src="{% static 'quality/js/Sortable.js' %}"></script>
    <script type="text/javascript" src="{% static 'quality/js/prettify.js' %}"></script>

    <script>
        initPictureUpload()
        function initPictureUpload(){
            let attached = document.querySelectorAll('.attached')
            for (i=1; i<5; i++){
                attached[i].style.display = 'none'
            }
        }
        //sortable 설정
        new Sortable(list_order, {
            animation: 150,
            ghostClass: 'blue-background-class',
            store: {
                get: function (sortable) {
                    var order = localStorage.getItem({{ data.pk }});
                    return order ? order.split('|') : [];
                },
                set: function (sortable) {
                    var order = sortable.toArray();
                    localStorage.setItem({{ data.pk }}, order.join('|'));
                    //데이터 저장 로직
                    var data = {
                        'pk': {{ data.pk }},
                        'data': localStorage.getItem(null),
                    }
                    postOrderData(data)

                }
            },
        });
        //윈도우 시작할 때 로컬 저장소에 리스트 순서 입력
        window.onload = function (){
            var temp = "{{ data.block_order }}"
            temp = JSON.parse(temp.replace(/&quot;/g,'"'));
            if(localStorage.getItem({{ data.pk }})){

            }else{
                localStorage.setItem({{ data.pk }},temp)
            }

        }

        function activeSelector(){

        }



        //서버 데이터 보냄
        function postOrderData(data) {
            $.ajax({
                url: "{% url 'update_block_order' %}",  // serviceKey 값을 xxxxxx에 입력
                type: "POST",
                data: JSON.stringify(data), // json 을 string으로 변환하여 전송
                dataType: "JSON",
                contentType: "application/json",
                accept: "application/json",
                success: function(result) {

                },
                error: function(result) {
                  console.log(result.responseText); //responseText의 에러메세지 확인

                }
            });
        }


    </script>

{% endblock %}

